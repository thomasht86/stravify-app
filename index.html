<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stravify – Overlay Your Photos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=directions_run" />
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --strava-orange: #FC4C02;
            --x-blue: #1d9bf0;
            --pico-font-family: 'Inter', sans-serif; /* Optional: Use Inter font like o3.html */
            --pico-color: #e2e8f0; /* Lighter text color */
            --pico-card-background-color: #1f2937; /* Darker card */
            --pico-card-border-color: #374151;
        }
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: var(--pico-font-family);
            background: linear-gradient(to bottom right, #111827, #1f2937, #111827);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
         /* Add margin on larger screens */
         @media (min-width: 1200px) { /* Adjust breakpoint if needed */
            main.container {
                /* Override Pico's default max-width for larger screens */
                max-width: 50vw; /* Content takes 50% width, leaving 25% margin each side */
                /* Auto margins handle the centering */
                margin-left: auto;
                margin-right: auto;
            }
        }
        header, footer {
            text-align: center;
        }
        header h1 {
            font-size: 3.5rem; /* Adjust size as needed */
            font-weight: 800;
            color: var(--strava-orange);
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        header p {
            font-size: 1.25rem;
            color: #9ca3af; /* Slightly muted color */
            margin-bottom: 1.5rem;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem;
            justify-content: center; /* Center remaining button */
            margin-bottom: 1.5rem;
        }
        .button-group label, .button-group a, .button-group button {
            margin-bottom: 0; /* Override Pico's default margin */
        }
        /* Custom Strava button */
        #stravaBtn {
            --pico-color: white;
            --pico-background-color: var(--strava-orange);
            --pico-border-color: var(--strava-orange);
            --pico-hover-background-color: #e14502; /* Darker orange on hover */
            --pico-hover-border-color: #e14502;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 0.5rem;
        }
        #stravaBtn.connected {
             --pico-background-color: #16a34a; /* Green */
             --pico-border-color: #16a34a;
             --pico-hover-background-color: #15803d;
             --pico-hover-border-color: #15803d;
             cursor: default;
        }
         /* Style file input trigger */
        /* REMOVED #uploadLabel styles */

        main {
            flex: 1; /* Ensure main content pushes footer down */
            padding-bottom: 2rem;
        }

        /* NEW: Upload Area Styles */
        #uploadArea {
            border: 2px dashed #4b5563; /* Dashed border */
            border-radius: 0.75rem; /* Rounded corners */
            padding: 2.5rem 1.5rem; /* Padding */
            text-align: center;
            cursor: pointer;
            background-color: rgba(31, 41, 55, 0.5); /* Slightly transparent dark background */
            color: #9ca3af; /* Muted text color */
            margin-bottom: 1.5rem;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem; /* Space between icon and text */
        }
        #uploadArea:hover {
            background-color: rgba(55, 65, 81, 0.6); /* Slightly lighter on hover */
            border-color: #6b7280;
        }
        #uploadArea svg {
            width: 3rem; /* Larger icon */
            height: 3rem;
            fill: #9ca3af; /* Icon color */
            margin-bottom: 0.5rem; /* Space below icon */
        }
        #uploadArea span {
            font-size: 1.1rem;
            font-weight: 500;
        }

        #preview-wrapper {
            position: relative;
            width: 100%;
            max-width: 90vw; /* Limit width */
            margin: 1rem auto; /* Center */
            border-radius: 1rem; /* Softer corners */
            overflow: hidden;
            /* aspect-ratio: 16 / 9;  Maintain aspect ratio */
            background-color: #374151; /* Placeholder background */
            display: flex; /* Center image */
            justify-content: center;
            align-items: center;
            border: 1px solid var(--pico-card-border-color);
            min-height: 200px; /* Ensure it has some height initially */
        }
        #preview-image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Fit image within container */
        }

        /* Overlay Card */
        #statsCard {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            color: #fff;
            border-radius: 0.75rem; /* Slightly larger radius */
            padding: 0.75rem 1rem; /* Adjust padding */
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Prevent scrolling on touch */
            width: clamp(180px, 40%, 260px); /* Responsive width */
            /* box-shadow: 0 4px 10px rgba(0,0,0,0.3); */
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* Initially hidden until image is loaded */
            visibility: hidden;
        }
        #statsCard:active {
            cursor: grabbing;
        }
        #statsCard h2 {
            font-size: 0.9rem; /* Smaller title */
            font-weight: 600;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: left;
            border-bottom: none; /* Override Pico */
            padding-bottom: 0; /* Override Pico */
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            text-align: center;
        }
        .stats-grid div span:first-child { /* Number */
            display: block;
            font-size: 1.1rem; /* Adjust size */
            font-weight: 700;
            line-height: 1.2;
        }
        .stats-grid div span:last-child { /* Unit */
            display: block;
            font-size: 0.65rem; /* Smaller unit */
            text-transform: uppercase;
            color: #cbd5e1; /* Lighter grey for units */
            opacity: 0.9;
            line-height: 1;
        }
        .no-select { /* Utility class */
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        /* Action Buttons Styling */
        .action-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .share-buttons {
            display: flex;
            gap: 1.5rem;
        }
        .share-buttons button {
            padding: 0.75rem; /* Make circular buttons */
            border-radius: 50%;
            line-height: 0; /* Center icon */
            width: 44px; /* Explicit size */
            height: 44px;
            border: none;
            box-shadow: var(--pico-card-box-shadow);
        }
        #shareXBtn {
            background-color: var(--x-blue);
            color: white;
        }
         #shareXBtn:hover {
             background-color: #198cd6; /* Darker X blue */
         }
        #shareInstaBtn {
             background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
             color: white;
        }
        #shareInstaBtn:hover {
             filter: brightness(1.1);
        }
        /* Hide default file input */
        input[type="file"].hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
         footer {
            color: #6b7280; /* Muted footer text */
            margin-top: auto; /* Push to bottom */
            padding: 1rem 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header class="container">
        <h1>STRAVIFY</h1>
        <p>your photo</p>
        <div class="button-group">
            <!-- Removed Upload Label -->
            <a id="stravaBtn" role="button" href="https://www.strava.com/oauth/authorize?client_id=76899&response_type=code&redirect_uri=https://thomasht86--stravify-oauth-fastapi-app.modal.run/login&approval_prompt=auto&scope=activity:read">
                <span id="stravaBtnText">Connect to Strava</span>
            </a>
        </div>
    </header>

    <main class="container">
        <!-- Hidden File Input -->
        <input id="upload" type="file" accept="image/*" class="hidden" />

        <!-- NEW: Upload Area -->
        <div id="uploadArea" aria-label="Upload Image Area">
            <!-- Generic image icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/>
            </svg>
            <span>Choose an image</span>
        </div>

        <div id="activityPicker" class="grid" style="display: none; margin-bottom: 1rem;">
             <label for="activities">
                 Choose an activity:
                 <select id="activities"></select>
             </label>
        </div>

        <div id="preview-wrapper">
            <img id="preview-image" alt="Preview image" crossorigin="anonymous">
            <div id="statsCard" class="no-select">
                <h2 id="activityTitle">Sample Activity</h2>
                <div class="stats-grid">
                    <div><span id="distance">--</span><span>km</span></div>
                    <div><span id="duration">--</span><span>hrs</span></div>
                    <div><span id="elev">--</span><span>m&nbsp;↑</span></div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button id="downloadBtn" class="contrast" disabled>
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/></svg>
                 Download Image
            </button>
            <div class="share-buttons">
                <button id="shareXBtn" aria-label="Share to X">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.601.75Zm-.86 13.028h1.36L4.323 2.145H2.865z"/></svg>
                 </button>
                <button id="shareInstaBtn" aria-label="Share to Instagram">
                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
                 </button>
            </div>
        </div>
    </main>

    <footer>Crafted with ❤️ and endorphins — © 2025 Stravify</footer>

    <script>
    (() => {
        'use strict';

        // --- DOM Elements ---
        const fileInput = document.getElementById('upload');
        const uploadArea = document.getElementById('uploadArea'); // Get the new upload area
        const downloadBtn = document.getElementById('downloadBtn');
        const wrapper = document.getElementById('preview-wrapper');
        const img = document.getElementById('preview-image');
        const overlay = document.getElementById('statsCard');
        const activityPicker = document.getElementById('activityPicker');
        const activitiesSelect = document.getElementById('activities');
        const stravaBtn = document.getElementById('stravaBtn');
        const stravaBtnText = document.getElementById('stravaBtnText');
        const shareXBtn = document.getElementById('shareXBtn');
        const shareInstaBtn = document.getElementById('shareInstaBtn');

        // Overlay Content Elements
        const ovTitle = document.getElementById('activityTitle');
        const ovDistance = document.getElementById('distance');
        const ovDuration = document.getElementById('duration');
        const ovElev = document.getElementById('elev');

        // --- State ---
        let authData = null;
        let drag = null; // {startX, startY, origX, origY}
        let currentActivities = []; // Store fetched activities
        const mockActivity = { // Define mock data
            id: 'mock-activity',
            name: 'Sample Run',
            distance: 5123.4, // meters
            moving_time: 1800, // seconds
            total_elevation_gain: 55.6,
            start_date_local: new Date().toISOString() // Use current date for mock
        };

        // --- Strava Auth & API ---
        function loadAuthData() {
            // Check hash for new token first
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            if (hashParams.has('access_token')) {
                const auth = {
                    access_token: hashParams.get('access_token'),
                    refresh_token: hashParams.get('refresh_token'),
                    expires_at: Number(hashParams.get('expires_at'))
                };
                localStorage.setItem('stravaAuth', JSON.stringify(auth));
                // Clean hash from URL
                history.replaceState(null, '', window.location.pathname + window.location.search);
                authData = auth;
            } else {
                // Check localStorage
                authData = JSON.parse(localStorage.getItem('stravaAuth') || 'null');
            }

            // TODO: Add token refresh logic if authData.expires_at is near/past

            updateStravaButtonState();
        }

        function updateStravaButtonState() {
            if (authData) {
                stravaBtn.href = '#'; // Prevent navigation
                stravaBtn.classList.add('connected');
                stravaBtnText.textContent = 'Connected to Strava ✅';
                stravaBtn.onclick = (e) => e.preventDefault(); // Disable click action
                fetchActivities();
            } else {
                 // Ensure button is in default state (handled by initial HTML/CSS)
                 // Make sure the click handler isn't prevented if user logs out/token expires
                 stravaBtn.onclick = null;
                 stravaBtn.classList.remove('connected'); // Ensure disconnected style
                 stravaBtnText.textContent = 'Connect to Strava'; // Reset text
                 stravaBtn.href = `https://www.strava.com/oauth/authorize?client_id=76899&response_type=code&redirect_uri=https://thomasht86--stravify-oauth-fastapi-app.modal.run/login&approval_prompt=auto&scope=activity:read`; // Reset href
                 populateActivitiesSelect([]); // Clear activities dropdown and show mock/connect prompt
                 updateOverlay(mockActivity); // Show mock data when not connected
            }
        }

        async function fetchActivities() {
            if (!authData) return;
            setLoadingState(true, stravaBtn); // Indicate loading on Strava button
            try {
                const response = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=10', { // Fetch more activities
                    headers: { Authorization: `Bearer ${authData.access_token}` }
                });
                if (!response.ok) {
                    if (response.status === 401) { // Unauthorized
                       console.error("Strava token expired or invalid.");
                       localStorage.removeItem('stravaAuth');
                       authData = null;
                       updateStravaButtonState(); // This will reset the button and clear activities
                       alert("Strava connection expired. Please connect again.");
                    } else {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                    currentActivities = []; // Clear activities on error
                } else {
                     currentActivities = await response.json();
                }
                 populateActivitiesSelect(currentActivities);

            } catch (err) {
                console.error("Error fetching Strava activities:", err);
                currentActivities = []; // Clear activities on error
                populateActivitiesSelect([]); // Show empty state
                alert("Could not fetch Strava activities. Please try again later.");
            } finally {
                 setLoadingState(false, stravaBtn);
            }
        }

        function populateActivitiesSelect(activities) {
            activitiesSelect.innerHTML = ''; // Clear previous options
            activityPicker.style.display = 'grid'; // Always show the picker

            if (authData) {
                if (activities.length > 0) {
                    activities.forEach((activity, index) => {
                        const option = new Option(
                            `${new Date(activity.start_date_local).toLocaleDateString()} - ${activity.name}`,
                            activity.id
                        );
                        option.dataset.index = index;
                        activitiesSelect.appendChild(option);
                    });
                    // Select the first activity by default if activities exist
                    if (activitiesSelect.options.length > 0) {
                        activitiesSelect.value = activitiesSelect.options[0].value;
                        updateOverlay(activities[0]); // Display first activity
                    }
                } else {
                    // Connected but no activities found
                    const option = new Option("No recent activities found", "");
                    option.disabled = true;
                    activitiesSelect.appendChild(option);
                    updateOverlay(); // Show default '--' placeholders
                }
            } else {
                // Not connected to Strava
                const connectOption = new Option("Connect to Strava to see activities", "");
                connectOption.disabled = true;
                activitiesSelect.appendChild(connectOption);

                const mockOption = new Option(
                    `${new Date(mockActivity.start_date_local).toLocaleDateString()} - ${mockActivity.name} (Sample)`,
                    mockActivity.id
                );
                mockOption.dataset.index = 'mock'; // Special index for mock
                activitiesSelect.appendChild(mockOption);
                activitiesSelect.value = mockActivity.id; // Select mock by default
                updateOverlay(mockActivity); // Ensure mock data is shown
            }
        }

        activitiesSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.selectedOptions[0];
            const selectedIndex = selectedOption?.dataset.index;

            if (selectedIndex === 'mock') {
                updateOverlay(mockActivity);
            } else if (selectedIndex !== undefined && currentActivities[selectedIndex]) {
                updateOverlay(currentActivities[selectedIndex]);
            } else {
                // Handle cases like "No activities found" or if something goes wrong
                updateOverlay(); // Show placeholders
            }
        });

        function secondsToHms(seconds) {
            if (isNaN(seconds) || seconds < 0) return '--';
            const s = Math.round(seconds); // Round to nearest second
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return h > 0
                ? `${h}:${String(m).padStart(2, '0')}` // Show H:MM
                : String(m); // Just show M if less than an hour
        }

        function updateOverlay(activity = null) {
            // Use provided activity, or mock if null AND not authenticated, else use placeholders
            const dataToShow = activity || (!authData ? mockActivity : null);

            ovTitle.textContent = dataToShow?.name || 'Activity Title';
            ovDistance.textContent = dataToShow ? (dataToShow.distance / 1000).toFixed(1) : '--';
            ovDuration.textContent = dataToShow ? secondsToHms(dataToShow.moving_time) : '--';
            ovElev.textContent = dataToShow ? Math.round(dataToShow.total_elevation_gain) : '--';
        }

        // --- Image Loading & Preview ---
        function loadImageFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                img.onload = () => {
                    enableDownload();
                    resetOverlayPosition();
                    overlay.style.visibility = 'visible'; // Show overlay card
                    // Optionally hide upload area after successful load
                    // uploadArea.style.display = 'none';
                };
                img.onerror = () => {
                    console.error("Error loading image.");
                    alert("Could not load the selected image file.");
                    disableDownload();
                    overlay.style.visibility = 'hidden'; // Hide overlay on error
                };
                img.src = e.target.result;
                img.alt = `Preview of ${file.name}`; // Update alt text
            };
            reader.onerror = () => {
                 console.error("Error reading file.");
                 alert("Could not read the selected file.");
                 disableDownload();
                 overlay.style.visibility = 'hidden'; // Hide overlay on error
            };
            reader.readAsDataURL(file);
        }

        // REMOVED loadDefaultImage function

        function enableDownload() { downloadBtn.disabled = false; }
        function disableDownload() { downloadBtn.disabled = true; }

        // Trigger file input when upload area is clicked
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImageFromFile(file);
            } else if (file) {
                 alert("Please select a valid image file.");
            }
            // Clear the input value to allow re-uploading the same file
             e.target.value = null;
        });

        // --- Overlay Dragging ---
         function resetOverlayPosition() {
            overlay.style.left = '1rem'; // Use initial CSS values
            overlay.style.top = '';      // Remove explicit top
            overlay.style.bottom = '1rem';// Use initial CSS values
        }

        function pointerDown(ev) {
            // Ensure the event target is the overlay itself or its child, not the image
            if (!overlay.contains(ev.target) || overlay.style.visibility === 'hidden') return;

            ev.preventDefault();
            const rect = overlay.getBoundingClientRect();
            const wrapperRect = wrapper.getBoundingClientRect();
            // Calculate initial position based on current style (could be top/left or bottom/left)
             const style = window.getComputedStyle(overlay);
             // Get position relative to the wrapper, accounting for potential scroll
             const currentTop = overlay.offsetTop;
             const currentLeft = overlay.offsetLeft;


            drag = {
                startX: ev.clientX,
                startY: ev.clientY,
                // Use offsetTop/Left relative to the wrapper for consistency
                origX: currentLeft,
                origY: currentTop
            };
            // Explicitly set top/left so movement works correctly from initial bottom/left
            overlay.style.bottom = 'auto';
            overlay.style.top = `${drag.origY}px`;
            overlay.style.left = `${drag.origX}px`;

            overlay.setPointerCapture(ev.pointerId);
            overlay.style.cursor = 'grabbing';
        }

        function pointerMove(ev) {
            if (!drag) return;
            ev.preventDefault();
            const dx = ev.clientX - drag.startX;
            const dy = ev.clientY - drag.startY;
            let newX = drag.origX + dx;
            let newY = drag.origY + dy;

            // Constrain within the wrapper boundaries
            const maxX = wrapper.clientWidth - overlay.offsetWidth;
            const maxY = wrapper.clientHeight - overlay.offsetHeight;
            newX = Math.max(0, Math.min(maxX, newX));
            newY = Math.max(0, Math.min(maxY, newY));

            overlay.style.left = `${newX}px`;
            overlay.style.top = `${newY}px`;
        }

        function pointerUp(ev) {
            if (!drag) return;
            overlay.releasePointerCapture(ev.pointerId);
            overlay.style.cursor = 'grab';
            drag = null;
        }

        // Use wrapper for event listeners to capture pointer events correctly
        wrapper.addEventListener('pointerdown', pointerDown);
        wrapper.addEventListener('pointermove', pointerMove);
        wrapper.addEventListener('pointerup', pointerUp);


        // --- Capture & Share ---
        function setLoadingState(isLoading, button = downloadBtn) {
            const relatedButton = button === shareXBtn ? shareXBtn : (button === shareInstaBtn ? shareInstaBtn : downloadBtn);
            if (isLoading) {
                relatedButton.ariaBusy = "true";
                relatedButton.disabled = true; // Disable while loading
            } else {
                relatedButton.ariaBusy = "false";
                 // Re-enable only if an image is loaded (for download/share buttons)
                 if (relatedButton !== stravaBtn) {
                     if (img.src && img.src !== window.location.href) { // Check if src is set and not just the base URL
                         relatedButton.disabled = false;
                     } else {
                         relatedButton.disabled = true; // Keep disabled if no image
                     }
                 } else {
                     // Re-enable Strava button based on auth state (handled elsewhere)
                     relatedButton.disabled = !!authData; // Disable if connected
                 }
            }
        }

        const capture = () => {
            setLoadingState(true, downloadBtn);
            console.log("Starting canvas capture...");
            // Temporarily remove border-radius and shadow for clean capture
            const prevRadius = wrapper.style.borderRadius;
            wrapper.style.borderRadius = '0';
            // Ensure overlay is visible for capture if it wasn't
            const overlayWasVisible = overlay.style.visibility !== 'hidden';
            overlay.style.visibility = 'visible';

            return html2canvas(wrapper, {
                useCORS: true, // Important for external images (default, user uploads)
                allowTaint: true, // May help with CORS issues but can taint canvas
                backgroundColor: null, // Preserve transparency if needed
                scale: 1, // Increase scale for higher resolution (e.g., 2x)
                logging: false // Disable html2canvas logging unless debugging
            })
            .then(canvas => {
                console.log("Canvas generated");
                 return new Promise((resolve, reject) => { // Added reject
                     canvas.toBlob((blob) => {
                         if (blob) {
                             console.log("Blob created, size:", blob.size);
                             resolve({ canvas, blob });
                         } else {
                             console.error("Failed to create blob from canvas.");
                             reject(new Error("Failed to create blob"));
                         }
                     }, 'image/png');
                 });
            })
            .catch(error => {
                console.error("html2canvas error:", error);
                alert(`Failed to capture image. Error: ${error.message}`);
                return Promise.reject(error); // Propagate the error
            })
            .finally(() => {
                // Restore styles after capture
                wrapper.style.borderRadius = prevRadius;
                if (!overlayWasVisible) {
                    overlay.style.visibility = 'hidden'; // Hide overlay again if it was initially hidden
                }
                setLoadingState(false, downloadBtn);
                 console.log("Capture process finished.");
            });
        };

        downloadBtn.addEventListener('click', () => {
            capture().then(({ canvas, blob }) => { // Using blob is often more reliable
                const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15); // YYYYMMDDTHHMMSS
                const filename = `stravify_${timestamp}.png`;
                const link = document.createElement('a');
                link.download = filename;
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href); // Clean up blob URL
            }).catch(err => { /* Error handled in capture() */ });
        });

        // Generic share function
        async function shareImage(platform) {
            const buttonToLoad = platform === 'X' ? shareXBtn : shareInstaBtn;
            setLoadingState(true, buttonToLoad);
            try {
                const { blob } = await capture();
                const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15);
                const filename = `stravify_${timestamp}.png`;
                const file = new File([blob], filename, { type: 'image/png' });
                const shareData = {
                    files: [file],
                    title: 'My Strava Activity',
                    text: `Check out my activity! #Stravify`,
                };

                if (navigator.canShare && navigator.canShare(shareData)) {
                     await navigator.share(shareData);
                     console.log("Shared successfully via Web Share API");
                } else {
                    // Fallback for specific platforms or if Web Share isn't supported/doesn't handle files
                    console.log("Web Share API not available or cannot share file, attempting fallback...");
                    if (platform === 'X') {
                        // X/Twitter Web Intent: Doesn't directly support image uploads via URL easily.
                        // Best fallback is to prompt download and tell user to upload manually.
                        alert('Sharing directly to X with the image is not supported by browsers. Please download the image and upload it manually.');
                        downloadBtn.click(); // Trigger download as fallback
                        // Or open tweet intent with text only:
                        // window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(shareData.text + ' ✨'), '_blank');
                    } else if (platform === 'Instagram') {
                         // Instagram doesn't have a web intent for sharing posts with images.
                         alert('Sharing directly to Instagram posts from the web is not possible. Please download the image and share it via the app.');
                         downloadBtn.click(); // Trigger download as fallback
                    } else {
                         // Generic fallback
                         alert('Sharing not supported on this browser/device. Please download the image.');
                         downloadBtn.click();
                    }
                }
            } catch (err) {
                if (err.name !== 'AbortError') { // Don't alert if user cancelled share sheet
                   console.error(`Error sharing to ${platform}:`, err);
                   alert(`Could not share the image. Error: ${err.message}`);
                } else {
                    console.log("Share action aborted by user.");
                }
            } finally {
                 setLoadingState(false, buttonToLoad);
            }
        }

        shareXBtn.addEventListener('click', () => shareImage('X'));
        shareInstaBtn.addEventListener('click', () => shareImage('Instagram'));


        // --- Initialization ---
        function init() {
            console.log("Initializing Stravify...");
            loadAuthData(); // Check auth status on load (this calls updateStravaButtonState which handles initial overlay/select)

            // Load placeholder image
            img.onload = () => {
                console.log("Placeholder image loaded.");
                resetOverlayPosition();
                overlay.style.visibility = 'visible'; // Show overlay
                disableDownload(); // Keep download disabled for placeholder
            };
            img.onerror = () => {
                console.error("Error loading placeholder image.");
                img.alt = 'Placeholder image failed to load.';
                overlay.style.visibility = 'visible'; // Still show overlay
                disableDownload();
            };
            img.src = 'https://picsum.photos/id/17/1600/1200'; // Set placeholder image source
            img.alt = 'Placeholder image - a landscape'; // Update alt text

            // Initial population is handled within loadAuthData -> updateStravaButtonState
            // No need to call populateActivitiesSelect or updateOverlay here again unless loadAuthData fails early

            console.log("Initialization complete.");
        }

        // --- Run ---
        init();

    })();
    </script>
</body>
</html>