<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stravify – Overlay Your Photos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <!-- Simplified Material Symbols Outlined link -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --strava-orange: #FC4C02;
            --pico-font-family: 'Inter', sans-serif; /* Optional: Use Inter font like o3.html */
            --pico-color: #e2e8f0; /* Lighter text color */
            --pico-card-background-color: #1f2937; /* Darker card */
            --pico-card-border-color: #374151;
        }
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: var(--pico-font-family);
            background: linear-gradient(to bottom right, #111827, #1f2937, #111827);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
         /* Add margin on larger screens */
         @media (min-width: 1200px) { /* Adjust breakpoint if needed */
            main.container {
                /* Override Pico's default max-width for larger screens */
                max-width: 50vw; /* Content takes 50% width, leaving 25% margin each side */
                /* Auto margins handle the centering */
                margin-left: auto;
                margin-right: auto;
            }
        }
        header, footer {
            text-align: center;
        }
        header h1 {
            font-size: 3.5rem; /* Adjust size as needed */
            font-weight: 800;
            color: var(--strava-orange);
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        header p {
            font-size: 1.25rem;
            color: #9ca3af; /* Slightly muted color */
            margin-bottom: 1.5rem;
        }
        .button-group {
            display: flex;
            flex-direction: column; /* Stack button and indicator */
            align-items: center; /* Center items horizontally */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 0.5rem; /* Reduced gap for indicator */
            justify-content: center; /* Center remaining button */
            margin-bottom: 1.5rem;
        }
        .button-group label, .button-group a, .button-group button {
            margin-bottom: 0; /* Override Pico's default margin */
        }
        /* Keep .connected styles for now, may need adjustment */
        #stravaBtn.connected {
             opacity: 0.8;
             cursor: default;
        }

        /* New Strava Status Indicator Styles */
        .strava-status {
            display: none; /* Hidden by default */
            font-size: 0.8rem;
            color: #6b7280; /* Muted grey */
            margin-top: -0.25rem; /* Adjust spacing slightly */
            transition: color 0.3s ease;
        }
        .strava-status.connected {
            display: inline; /* Show when connected */
            color: #22c55e; /* Green color for connected */
            font-weight: 500;
        }

        main {
            flex: 1; /* Ensure main content pushes footer down */
            padding-bottom: 2rem;
        }

        /* NEW: Upload Area Styles */
        #uploadArea {
            border: 2px dashed #4b5563; /* Dashed border */
            border-radius: 0.75rem; /* Rounded corners */
            padding: 2.5rem 1.5rem; /* Padding */
            text-align: center;
            cursor: pointer;
            background-color: rgba(31, 41, 55, 0.5); /* Slightly transparent dark background */
            color: #9ca3af; /* Muted text color */
            margin-bottom: 1.5rem;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem; /* Space between icon and text */
        }
        #uploadArea:hover {
            background-color: rgba(55, 65, 81, 0.6); /* Slightly lighter on hover */
            border-color:var(--strava-orange);
        }
        #uploadArea svg {
            width: 3rem; /* Larger icon */
            height: 3rem;
            fill: #9ca3af; /* Icon color */
            margin-bottom: 0.5rem; /* Space below icon */
        }
        #uploadArea span {
            font-size: 1.1rem;
            font-weight: 500;
        }

        #preview-wrapper {
            position: relative;
            width: 100%;
            max-width: 90vw; /* Limit width */
            margin: 1rem auto; /* Center */
            border-radius: 1rem; /* Softer corners */
            overflow: hidden;
            background-color: #374151; /* Placeholder background */
            display: flex; /* Center image */
            justify-content: center;
            align-items: center;
            border: 1px solid var(--pico-card-border-color);
            min-height: 200px; /* Ensure it has some height initially */
        }
        #preview-image {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Fit image within container */
        }

        /* Overlay Card */
        #statsCard {
            position: absolute;
            bottom: 1rem;
            left: 0.2rem;
            right: auto;
            background: rgba(52, 54, 54, 0.243);
            backdrop-filter: blur(4px);
            color: #fff;
            border-radius: 0.75rem; /* Slightly larger radius */
            padding: 0.4rem 0.6rem; /* Slightly reduced padding */
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Prevent scrolling on touch */
            max-width: 50%; /* Added max-width constraint */
            max-height: 40%; /* Relaxed max-height constraint */
            overflow: hidden; /* Prevent content overflow */
            /* border: 1px solid rgba(255, 255, 255, 0.1); */
            visibility: hidden;
            display: flex; /* Use flexbox for layout */
            flex-direction: column; /* Stack items vertically */
            gap: 0.15rem; /* Further reduced gap */
        }
        #statsCard:active {
            cursor: grabbing;
        }
        #statsCard h2 {
            font-size: 0.7rem; /* Further reduced title size */
            font-weight: 600;
            margin-bottom: 0; /* Remove default margin */
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center; /* Center align */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            line-clamp: 2; /* Standard property */
            -webkit-box-orient: vertical;
            line-height: 1.1; /* Slightly reduced line height */
            min-height: 1.6em; /* Ensure minimum space for two lines */
            flex-shrink: 0; /* Prevent title from shrinking vertically */
        }
        /* New container for icon and grid */
        .stats-row {
            display: flex;
            align-items: center; /* Vertically align icon and grid */
            gap: 0.3rem; /* Further reduced space */
            flex-grow: 1; /* Allow this row to take remaining space */
            min-height: 0; /* Allow shrinking if needed within flex context */
        }
        /* Activity Icon Style */
        #activityIcon {
            font-size: 1.5rem; /* Further reduced icon size */
            line-height: 1;
            color: white; /* var(--strava-orange); */
            flex-shrink: 0; /* Prevent icon from shrinking */
            display: flex;
            align-items: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: auto auto; /* Add this for two rows */
            gap: 0.2rem 0.2rem; /* Further reduced gap (row column) */
            text-align: center;
            flex-grow: 1; /* Allow grid to take remaining space */
            min-height: 0; /* Allow shrinking */
        }
        /* Ensure unit styles are applied */
        .stats-grid div span:first-child { /* Number */
            display: block;
            font-size: 0.7rem; /* Further reduced font size */
            font-weight: 700;
            line-height: 1.1;
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .stats-grid div span:last-child { /* Unit */
            display: block;
            font-size: 0.55rem; /* Further reduced font size */
            text-transform: uppercase;
            color: #cbd5e1;
            opacity: 0.9;
            line-height: 1;
            white-space: nowrap; /* Prevent wrapping */
        }
        .no-select { /* Utility class */
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none; /* Added for IE/Edge */
        }
        /* Action Buttons Styling */
        .action-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        #stravaPoweredLogo {
            margin-top: 1rem;
            height: 14px; /* Adjust height as needed */
            width: auto; /* Maintain aspect ratio */
            vertical-align: middle; /* Align with buttons if needed */
        }
        /* Hide default file input */
        input[type="file"].hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
         footer {
            color: #6b7280; /* Muted footer text */
            margin-top: auto; /* Push to bottom */
            padding: 1rem 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <header class="container">
        <h1>STRAVIFY</h1>
        <p>your photo</p>
        <div class="button-group">
            <a id="stravaBtn" role="button" href="https://www.strava.com/oauth/authorize?client_id=76899&response_type=code&redirect_uri=https://thomasht86--stravify-oauth-fastapi-app.modal.run/login&approval_prompt=auto&scope=activity:read" style="background: none; border: none; padding: 0; display: inline-block; vertical-align: middle;">
                <img src="assets/btn_strava_connect_with_orange.svg" alt="Connect with Strava" style="display: block; height: 48px; width: auto;">
            </a>
            <span id="stravaStatusIndicator" class="strava-status"></span>
        </div>
    </header>

    <main class="container">
        <input id="upload" type="file" accept="image/*" class="hidden" />

        <div id="uploadArea" aria-label="Upload Image Area">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/>
            </svg>
            <span>Choose an image</span>
        </div>

        <div id="activityPicker" class="grid" style="display: none; margin-bottom: 1rem;">
             <label for="activities">
                 Choose an activity:
                 <select id="activities"></select>
             </label>
        </div>

        <div id="preview-wrapper">
            <img id="preview-image" alt="Preview image" crossorigin="anonymous">
            <div id="statsCard" class="no-select">
                <h2 id="activityTitle">Sample Activity</h2>
                <div class="stats-row">
                    <span id="activityIcon" class="material-symbols-outlined"></span>
                    <div class="stats-grid">
                        <!-- Row 1 -->
                        <div><span id="distance">--</span><span>km</span></div>
                        <div><span id="duration">--</span><span>HRS</span></div>
                        <div><span id="elev">--</span><span>m&nbsp;↑</span></div>
                        <!-- Row 2: New Stats -->
                        <div id="avgHrDiv" style="display: none;"><span id="avgHr">--</span><span>bpm</span></div>
                        <div id="avgSpeedDiv" style="display: none;"><span id="avgSpeed">--</span><span id="avgSpeedUnit">km/h</span></div>
                        <div id="sufferScoreDiv" style="display: none;"><span id="sufferScore">--</span><span>suffer</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button id="downloadBtn" class="contrast" disabled>
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/></svg>
                 Download Image
            </button>
            <img src="assets/poweredbystrava.svg" alt="Powered by Strava" id="stravaPoweredLogo">
        </div>
    </main>

    <footer>Crafted with ❤️ and endorphins — © 2025 Stravify</footer>

    <script>
    (() => {
        'use strict';

        const fileInput = document.getElementById('upload');
        const uploadArea = document.getElementById('uploadArea');
        const downloadBtn = document.getElementById('downloadBtn');
        const wrapper = document.getElementById('preview-wrapper');
        const img = document.getElementById('preview-image');
        const overlay = document.getElementById('statsCard');
        const activityPicker = document.getElementById('activityPicker');
        const activitiesSelect = document.getElementById('activities');
        const stravaBtn = document.getElementById('stravaBtn');
        const stravaStatusIndicator = document.getElementById('stravaStatusIndicator');

        const ovTitle = document.getElementById('activityTitle');
        const ovIcon = document.getElementById('activityIcon');
        const ovDistance = document.getElementById('distance');
        const ovDuration = document.getElementById('duration');
        const ovElev = document.getElementById('elev');
        // New stat element references
        const avgHrDiv = document.getElementById('avgHrDiv');
        const ovAvgHr = document.getElementById('avgHr');
        const avgSpeedDiv = document.getElementById('avgSpeedDiv');
        const ovAvgSpeed = document.getElementById('avgSpeed');
        const ovAvgSpeedUnit = document.getElementById('avgSpeedUnit');
        const sufferScoreDiv = document.getElementById('sufferScoreDiv');
        const ovSufferScore = document.getElementById('sufferScore');

        let authData = null;
        let drag = null;
        let currentActivities = [];
        // Updated mock data
        const mockActivities = [
            { id: 'mock-run', name: 'Morning Run', type: 'Run', distance: 5123.4, moving_time: 1800, total_elevation_gain: 55.6, start_date_local: new Date(Date.now() - 86400000).toISOString(), average_heartrate: 155.2, average_speed: 2.846, suffer_score: 45 },
            { id: 'mock-ride', name: 'Weekend Ride', type: 'Ride', distance: 25450.1, moving_time: 5400, total_elevation_gain: 210.3, start_date_local: new Date(Date.now() - 2*86400000).toISOString(), average_heartrate: 138.9, average_speed: 4.713, suffer_score: 60 },
            { id: 'mock-walk', name: 'Evening Walk', type: 'Walk', distance: 3050.0, moving_time: 2700, total_elevation_gain: 15.0, start_date_local: new Date(Date.now() - 3*86400000).toISOString(), average_heartrate: 95.5, average_speed: 1.13 },
            { id: 'mock-hike', name: 'Mountain Hike', type: 'Hike', distance: 12800.5, moving_time: 10800, total_elevation_gain: 650.8, start_date_local: new Date(Date.now() - 4*86400000).toISOString(), average_speed: 1.185, suffer_score: 80 },
            { id: 'mock-other', name: 'Gym Session', type: 'Workout', distance: 0, moving_time: 3600, total_elevation_gain: 0, start_date_local: new Date(Date.now() - 5*86400000).toISOString(), average_heartrate: 110.0 }
        ];
        let selectedMockActivity = mockActivities[0];

        // --- NEW: Debounce Function ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- NEW: Scaling Constants ---
        const BASE_PREVIEW_WIDTH = 360; // Reference width where scale is 1
        const MAX_SCALE_FACTOR = 1.8; // Optional: Limit maximum scaling

        // --- NEW: Scaling Function ---
        function updateOverlayScale() {
            // Ensure wrapper and overlay exist and image is loaded/visible
            if (!wrapper || !overlay || !img.complete || img.naturalWidth === 0 || overlay.style.visibility === 'hidden') {
                return;
            }

            const currentWidth = wrapper.clientWidth;
            let scaleFactor = currentWidth / BASE_PREVIEW_WIDTH;
            // Clamp scale factor between 1 and the max limit
            scaleFactor = Math.max(1, Math.min(MAX_SCALE_FACTOR, scaleFactor));

            overlay.style.transformOrigin = 'top left'; // <<< CHANGED from 'bottom left'
            overlay.style.transform = `scale(${scaleFactor})`;
        }

        // --- NEW: Debounced version for resize events ---
        const debouncedUpdateOverlayScale = debounce(updateOverlayScale, 100);

        function loadAuthData() {
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            if (hashParams.has('access_token')) {
                const auth = {
                    access_token: hashParams.get('access_token'),
                    refresh_token: hashParams.get('refresh_token'),
                    expires_at: Number(hashParams.get('expires_at'))
                };
                localStorage.setItem('stravaAuth', JSON.stringify(auth));
                history.replaceState(null, '', window.location.pathname + window.location.search);
                authData = auth;
            } else {
                authData = JSON.parse(localStorage.getItem('stravaAuth') || 'null');
            }

            updateStravaButtonState();
        }

        function updateStravaButtonState() {
            if (authData) {
                stravaBtn.href = '#';
                stravaBtn.classList.add('connected');
                stravaBtn.onclick = (e) => e.preventDefault();

                stravaStatusIndicator.textContent = 'Connected ✅';
                stravaStatusIndicator.classList.add('connected');

                fetchActivities();
            } else {
                stravaBtn.onclick = null;
                stravaBtn.classList.remove('connected');
                stravaBtn.href = `https://www.strava.com/oauth/authorize?client_id=76899&response_type=code&redirect_uri=https://thomasht86--stravify-oauth-fastapi-app.modal.run/login&approval_prompt=auto&scope=activity:read`;

                stravaStatusIndicator.textContent = '';
                stravaStatusIndicator.classList.remove('connected');

                populateActivitiesSelect([]);
                updateOverlay(selectedMockActivity);
            }
        }

        async function fetchActivities() {
            if (!authData) return;
            setLoadingState(true, stravaBtn);
            try {
                const response = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=10', {
                    headers: { Authorization: `Bearer ${authData.access_token}` }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error("Strava token expired or invalid.");
                        localStorage.removeItem('stravaAuth');
                        authData = null;
                        updateStravaButtonState();
                        alert("Strava connection expired. Please connect again.");
                    } else {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                    currentActivities = [];
                } else {
                    currentActivities = await response.json();
                }
                populateActivitiesSelect(currentActivities);

            } catch (err) {
                console.error("Error fetching Strava activities:", err);
                currentActivities = [];
                populateActivitiesSelect([]);
                alert("Could not fetch Strava activities. Please try again later.");
            } finally {
                setLoadingState(false, stravaBtn);
            }
        }

        function populateActivitiesSelect(activities) {
            activitiesSelect.innerHTML = '';
            activityPicker.style.display = 'grid';

            if (authData) {
                if (activities.length > 0) {
                    activities.forEach((activity, index) => {
                        const option = new Option(
                            `${new Date(activity.start_date_local).toLocaleDateString()} - ${activity.name} (${activity.type || 'Activity'})`,
                            activity.id
                        );
                        option.dataset.index = index;
                        activitiesSelect.appendChild(option);
                    });
                    if (activitiesSelect.options.length > 0) {
                        activitiesSelect.value = activitiesSelect.options[0].value;
                        updateOverlay(activities[0]);
                    }
                } else {
                    const option = new Option("No recent activities found", "");
                    option.disabled = true;
                    activitiesSelect.appendChild(option);
                    updateOverlay();
                }
            } else {
                const connectOption = new Option("Connect to Strava to see your activities", "");
                connectOption.disabled = true;
                activitiesSelect.appendChild(connectOption);

                mockActivities.forEach((activity, index) => {
                    const option = new Option(
                        `${new Date(activity.start_date_local).toLocaleDateString()} - ${activity.name} (Sample)`,
                        activity.id
                    );
                    option.dataset.index = index;
                    option.dataset.mock = 'true';
                    activitiesSelect.appendChild(option);
                });

                activitiesSelect.value = selectedMockActivity.id;
                updateOverlay(selectedMockActivity);
            }
        }

        activitiesSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.selectedOptions[0];
            const selectedIndex = selectedOption?.dataset.index;
            const isMock = selectedOption?.dataset.mock === 'true';

            if (isMock && selectedIndex !== undefined && mockActivities[selectedIndex]) {
                selectedMockActivity = mockActivities[selectedIndex];
                updateOverlay(selectedMockActivity);
            } else if (!isMock && selectedIndex !== undefined && currentActivities[selectedIndex]) {
                updateOverlay(currentActivities[selectedIndex]);
            } else {
                updateOverlay();
            }
        });

        function secondsToHms(seconds) {
            if (isNaN(seconds) || seconds < 0) return '--';
            const s = Math.round(seconds);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60; // Calculate seconds
            // Format as H:MM:SS
            return `${h}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }

        function getActivityIcon(type) {
            if (!type) return '';
            const typeLower = type.toLowerCase();
            switch (typeLower) {
                case 'run': return 'directions_run';
                case 'ride': return 'directions_bike';
                case 'walk': return 'directions_walk';
                case 'hike': return 'hiking';
                case 'swim': return 'pool';
                case 'workout': return 'fitness_center';
                default: return 'exercise';
            }
        }

        function formatSpeed(speedMps, activityType) {
            if (isNaN(speedMps) || speedMps <= 0) return { value: '--', unit: '' };

            const typeLower = activityType?.toLowerCase() || '';

            if (typeLower === 'run' || typeLower === 'walk' || typeLower === 'hike') {
                const paceDecimal = 1000 / (speedMps * 60); // minutes per km
                if (!isFinite(paceDecimal)) return { value: '--', unit: 'min/km' };
                const minutes = Math.floor(paceDecimal);
                const seconds = Math.round((paceDecimal - minutes) * 60);
                return { value: `${minutes}:${String(seconds).padStart(2, '0')}`, unit: 'min/km' };
            } else if (typeLower === 'ride' || typeLower === 'ebikeride' || typeLower === 'handcycle' || typeLower === 'velomobile') {
                const speedKph = speedMps * 3.6;
                return { value: speedKph.toFixed(1), unit: 'km/h' };
            } else {
                const speedKph = speedMps * 3.6;
                return { value: speedKph.toFixed(1), unit: 'km/h' };
            }
        }

        function updateOverlay(activity = null) {
            const dataToShow = activity || (!authData ? selectedMockActivity : null);
            console.log("Updating overlay with data:", dataToShow);

            // --- Row 1 ---
            ovTitle.textContent = dataToShow?.name || 'Activity Title';
            ovDistance.textContent = dataToShow?.distance ? (dataToShow.distance / 1000).toFixed(1) : '--';
            ovDuration.textContent = dataToShow?.moving_time ? secondsToHms(dataToShow.moving_time) : '--';
            ovElev.textContent = dataToShow?.total_elevation_gain ? Math.round(dataToShow.total_elevation_gain) : '--';
            const iconName = dataToShow ? getActivityIcon(dataToShow.type) : '';
            ovIcon.textContent = iconName;
            ovIcon.style.display = iconName ? 'inline-block' : 'none';

            // --- Row 2 ---
            if (dataToShow?.average_heartrate) {
                ovAvgHr.textContent = Math.round(dataToShow.average_heartrate);
                avgHrDiv.style.display = 'block';
            } else {
                avgHrDiv.style.display = 'none';
            }
            if (dataToShow?.average_speed) {
                const { value, unit } = formatSpeed(dataToShow.average_speed, dataToShow.type);
                ovAvgSpeed.textContent = value;
                ovAvgSpeedUnit.textContent = unit;
                avgSpeedDiv.style.display = value !== '--' ? 'block' : 'none';
            } else {
                avgSpeedDiv.style.display = 'none';
            }
            if (dataToShow?.suffer_score) {
                ovSufferScore.textContent = dataToShow.suffer_score;
                sufferScoreDiv.style.display = 'block';
            } else {
                sufferScoreDiv.style.display = 'none';
            }
        }

        function loadImageFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                img.onload = () => {
                    enableDownload();
                    resetOverlayPosition(); // Reset position before scaling
                    overlay.style.visibility = 'visible';
                    updateOverlayScale(); // <<< Apply scale after image loads
                };
                img.onerror = () => {
                    console.error("Error loading image.");
                    alert("Could not load the selected image file.");
                    disableDownload();
                    overlay.style.visibility = 'hidden';
                };
                img.src = e.target.result;
                img.alt = `Preview of ${file.name}`;
            };
            reader.onerror = () => {
                console.error("Error reading file.");
                alert("Could not read the selected file.");
                disableDownload();
                overlay.style.visibility = 'hidden';
            };
            reader.readAsDataURL(file);
        }

        function enableDownload() { downloadBtn.disabled = false; }
        function disableDownload() { downloadBtn.disabled = true; }

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImageFromFile(file);
            } else if (file) {
                alert("Please select a valid image file.");
            }
            e.target.value = null;
        });

        function resetOverlayPosition() {
            overlay.style.left = '1rem';
            overlay.style.top = '1rem'; // <<< CHANGED from 'bottom: 1rem'
            overlay.style.bottom = 'auto'; // <<< Ensure bottom is not set
            overlay.style.transform = 'scale(1)'; // Reset scale on position reset
        }

        function pointerDown(ev) {
            if (!overlay.contains(ev.target) || overlay.style.visibility === 'hidden') return;
            ev.preventDefault();
            const currentTop = overlay.offsetTop;
            const currentLeft = overlay.offsetLeft;
            drag = {
                startX: ev.clientX,
                startY: ev.clientY,
                origX: currentLeft,
                origY: currentTop,
            };
            overlay.style.bottom = 'auto';
            overlay.style.top = `${drag.origY}px`;
            overlay.style.left = `${drag.origX}px`;
            overlay.setPointerCapture(ev.pointerId);
            overlay.style.cursor = 'grabbing';
        }

        // --- MODIFIED: pointerMove to use scaled dimensions for constraints ---
        function pointerMove(ev) {
            if (!drag) return;
            ev.preventDefault();
            const dx = ev.clientX - drag.startX;
            const dy = ev.clientY - drag.startY;
            let newX = drag.origX + dx;
            let newY = drag.origY + dy;

            // Get scaled dimensions using getBoundingClientRect
            const overlayRect = overlay.getBoundingClientRect();
            const scaledWidth = overlayRect.width;
            const scaledHeight = overlayRect.height;

            // Calculate max X/Y based on wrapper dimensions and scaled overlay dimensions
            const maxX = wrapper.clientWidth - scaledWidth;
            const maxY = wrapper.clientHeight - scaledHeight;

            // Clamp position
            newX = Math.max(0, Math.min(maxX, newX));
            newY = Math.max(0, Math.min(maxY, newY));

            overlay.style.left = `${newX}px`;
            overlay.style.top = `${newY}px`;
        }

        function pointerUp(ev) {
            if (!drag) return;
            overlay.releasePointerCapture(ev.pointerId);
            overlay.style.cursor = 'grab';
            drag = null;
        }

        wrapper.addEventListener('pointerdown', pointerDown);
        wrapper.addEventListener('pointermove', pointerMove);
        wrapper.addEventListener('pointerup', pointerUp);

        function setLoadingState(isLoading, button) {
            if (isLoading) {
                button.ariaBusy = "true";
                button.disabled = true;
            } else {
                button.ariaBusy = "false";
                if (button === downloadBtn) {
                    if (img.src && img.src !== window.location.href) { 
                        button.disabled = false;
                    } else {
                        button.disabled = true; 
                    }
                } else if (button === stravaBtn) {
                    button.disabled = !!authData; 
                } else {
                    button.disabled = false;
                }
            }
        }

        const capture = () => {
            setLoadingState(true, downloadBtn);
            const prevRadius = wrapper.style.borderRadius;
            wrapper.style.borderRadius = '0';
            const overlayWasVisible = overlay.style.visibility !== 'hidden';
            overlay.style.visibility = 'visible';
            return html2canvas(wrapper, {
                useCORS: true, 
                allowTaint: true, 
                backgroundColor: null, 
                scale: 1, 
                logging: false 
            })
            .then(canvas => {
                return new Promise((resolve, reject) => { 
                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve({ canvas, blob });
                        } else {
                            reject(new Error("Failed to create blob"));
                        }
                    }, 'image/png');
                });
            })
            .catch(error => {
                alert(`Failed to capture image. Error: ${error.message}`);
                return Promise.reject(error);
            })
            .finally(() => {
                wrapper.style.borderRadius = prevRadius;
                if (!overlayWasVisible) {
                    overlay.style.visibility = 'hidden'; 
                }
                setLoadingState(false, downloadBtn);
            });
        };

        downloadBtn.addEventListener('click', () => {
            capture().then(({ canvas, blob }) => {
                const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15); 
                const filename = `stravify_${timestamp}.png`;
                const link = document.createElement('a');
                link.download = filename;
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href); 
            }).catch(err => { });
        });

        function init() {
            loadAuthData();
            img.onload = () => {
                resetOverlayPosition(); // Resets scale too
                overlay.style.visibility = 'visible';
                disableDownload();
                updateOverlay(authData ? null : selectedMockActivity);
                updateOverlayScale(); // <<< Apply scale after placeholder loads
            };
            img.onerror = () => {
                img.alt = 'Placeholder image failed to load.';
                resetOverlayPosition(); // Resets scale too
                overlay.style.visibility = 'visible';
                disableDownload();
                updateOverlay(authData ? null : selectedMockActivity);
                updateOverlayScale(); // <<< Apply scale even if placeholder fails
            };
            img.src = 'https://picsum.photos/id/17/1600/1200';
            img.alt = 'Placeholder image - a landscape';

            // --- NEW: Add resize listener ---
            window.addEventListener('resize', debouncedUpdateOverlayScale);
        }
        init();
    })();
    </script>
</body>
</html>